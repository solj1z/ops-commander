<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ops Commander // EKS Control Plane</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --green: #22c55e; --red: #ef4444; --yellow: #eab308; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #334155; padding-bottom: 20px; margin-bottom: 20px; }
        .container { display: grid; grid-template-columns: 320px 1fr; gap: 20px; flex: 1; overflow: hidden; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 15px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 10px; font-size: 1rem; }
        .btn-stress { background: var(--yellow); color: black; }
        .btn-stress.active { background: var(--red); color: white; animation: pulse 2s infinite; }
        .btn-kill { background: var(--red); }
        .pod-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; overflow-y: auto; }
        
        /* POD STYLES */
        .pod { background: #334155; padding: 10px; border-radius: 8px; text-align: center; border: 2px solid transparent; transition: 0.3s; }
        .pod.Running { border-color: var(--green); background: rgba(34, 197, 94, 0.1); }
        .pod.Pending { border-color: var(--yellow); }
        .pod.ContainerCreating { border-color: var(--yellow); }
        
        /* TERMINATING STYLE (Red & Fade) */
        .pod.Terminating { 
            border-color: var(--red); 
            background: rgba(239, 68, 68, 0.2); 
            opacity: 0.6; 
            transform: scale(0.95);
        }

        .terminal { background: #000; border-radius: 8px; padding: 15px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; border: 1px solid #334155; display: flex; flex-direction: column-reverse; height: 150px;}
        .log-entry { margin-bottom: 4px; border-left: 3px solid #333; padding-left: 10px; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Ops Commander</h1>
        <div style="background:#3b82f6; padding:5px 10px; border-radius:4px; font-size:0.8rem;">‚óè LIVE</div>
    </div>
    <div class="container">
        <div>
            <div class="card">
                <h2>‚ö†Ô∏è STRESS TEST</h2>
                <button class="btn-stress" id="stressBtn" onclick="toggleStress()">ACTIVATE LOAD</button>
            </div>
            <div class="card">
                <h2>üíÄ CHAOS MONKEY</h2>
                <button class="btn-kill" onclick="killPod()">KILL RANDOM POD</button>
            </div>
            <div class="card">
                <strong>Active Pods: <span id="podCount" style="color:var(--green)">...</span></strong>
            </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:20px; overflow:hidden;">
            <div class="card" style="flex:1; display:flex; flex-direction:column;">
                <h2>BACKEND REPLICAS</h2>
                <div class="pod-grid" id="podGrid"></div>
            </div>
            <div class="terminal" id="terminal"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api'; 
        let stressActive = false;
        const pods = {};

        // 1. INIT
        async function init() {
            try {
                const res = await fetch(`${API_URL}/status`);
                const data = await res.json();
                if (data.stress_active) {
                    stressActive = true;
                    updateStressUI();
                }
                data.pods.forEach(p => updatePodGrid({ k8s_type: 'ADDED', pod: p.name, status: p.status }));
            } catch (e) { console.error(e); }
        }

        // 2. ACTIONS
        async function toggleStress() {
            stressActive = !stressActive;
            updateStressUI();
            await fetch(`${API_URL}/stress`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ active: stressActive })
            });
        }
        
        function updateStressUI() {
            const btn = document.getElementById('stressBtn');
            if(stressActive) {
                btn.innerText = "STOP LOAD";
                btn.classList.add('active');
            } else {
                btn.innerText = "ACTIVATE LOAD";
                btn.classList.remove('active');
            }
        }

        async function killPod() { await fetch(`${API_URL}/kill`, { method: 'POST' }); }

        // 3. EVENT STREAM
        const evtSource = new EventSource(`${API_URL}/events`);
        evtSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'SYSTEM_ALERT' && data.msg.includes("STOPPED") && stressActive) {
                stressActive = false;
                updateStressUI();
            }
            logEvent(data);
            if (data.type === 'K8S_EVENT') updatePodGrid(data);
        };

        // 4. UI LOGIC (Fixed for Terminating)
        function updatePodGrid(data) {
            const grid = document.getElementById('podGrid');
            const { pod, status, k8s_type } = data;

            if (k8s_type === 'DELETED') {
                const el = document.getElementById(pod);
                if (el) {
                    el.remove();
                    delete pods[pod];
                }
                updateCount();
                return;
            }

            let el = document.getElementById(pod);
            if (!el) {
                el = document.createElement('div');
                el.id = pod;
                el.innerHTML = `<div style="font-size:2rem">üì¶</div><small>${pod.slice(-5)}</small><div class="status-text">${status}</div>`;
                grid.appendChild(el);
            }

            // FORCE CLASS UPDATE (This triggers the Red color)
            el.className = `pod ${status}`;
            el.querySelector('.status-text').innerText = status;
            
            // Logic for active count
            if (status === 'Terminating') delete pods[pod];
            else pods[pod] = status;
            
            updateCount();
        }

        function updateCount() {
            document.getElementById('podCount').innerText = Object.keys(pods).length;
        }

        function logEvent(data) {
            const term = document.getElementById('terminal');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            let color = "#fff";
            if (data.type === 'CHAOS_EVENT') color = "#ef4444";
            if (data.type === 'SYSTEM_ALERT') color = "#eab308";
            if (data.type === 'K8S_EVENT' && data.k8s_type === 'ADDED') color = "#22c55e";
            
            entry.innerHTML = `<span style="color:#666">[${time}]</span> <span style="color:${color}">${data.msg || data.pod + ' ' + data.status}</span>`;
            term.prepend(entry);
        }

        window.onload = init;
    </script>
</body>
</html>
